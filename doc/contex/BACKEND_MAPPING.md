# üèóÔ∏è Mapeamento Estrutural do Backend - Credifit

Este documento fornece um mapeamento completo da estrutura, funcionalidades e componentes do backend da aplica√ß√£o Credifit.

## üìÇ Estrutura do Projeto

### Arquitetura Geral
```
backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main.ts                 # Ponto de entrada da aplica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ app.module.ts           # M√≥dulo principal
‚îÇ   ‚îú‚îÄ‚îÄ api/                    # M√≥dulos de API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/              # Autentica√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ company/           # Empresas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ employee/          # Funcion√°rios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ loan/              # Empr√©stimos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ analysis/          # An√°lise de cr√©dito
‚îÇ   ‚îî‚îÄ‚îÄ prisma/                # Servi√ßo de banco de dados
‚îú‚îÄ‚îÄ prisma/                     # Schema e migra√ß√µes
‚îú‚îÄ‚îÄ test/                       # Testes E2E
‚îî‚îÄ‚îÄ dist/                       # Build de produ√ß√£o
```

### Tecnologias Utilizadas
- **Framework:** NestJS v11.0.1
- **ORM:** Prisma v6.11.1
- **Banco de Dados:** SQLite
- **Autentica√ß√£o:** JWT (@nestjs/jwt)
- **Valida√ß√£o:** class-validator, class-transformer
- **Documenta√ß√£o:** Swagger/OpenAPI
- **Criptografia:** bcrypt
- **Testes:** Jest

## üèõÔ∏è Arquitetura Modular

### App Module
**Arquivo:** `src/app.module.ts`

```typescript
@Module({
  imports: [
    PrismaModule,      // Conex√£o com banco de dados
    CompanyModule,     // M√≥dulo de empresas
    EmployeeModule,    // M√≥dulo de funcion√°rios
    LoanModule,        // M√≥dulo de empr√©stimos
    AnalysisModule,    // M√≥dulo de an√°lise
    AuthModule,        // M√≥dulo de autentica√ß√£o
  ],
})
```

### Bootstrap (main.ts)
**Arquivo:** `src/main.ts`

**Configura√ß√µes:**
- **Porta:** 3000 (padr√£o)
- **Swagger:** `/api` endpoint
- **CORS:** Habilitado para todas as origens
- **Validation Pipe:** Global com whitelist
- **Documenta√ß√£o:** Swagger UI autom√°tico

## üìä Modelo de Dados

### Schema Prisma
**Arquivo:** `prisma/schema.prisma`

```mermaid
erDiagram
    Company {
        int id PK
        string name
        string razaoSocial
        string email UK
        string password
        string cnpj UK
        datetime createdAt
        datetime updatedAt
    }
    
    Employee {
        int id PK
        string name
        string cpf UK
        string email UK
        string password
        float salary
        int companyId FK
        datetime createdAt
        datetime updatedAt
    }
    
    Loan {
        int id PK
        int employeeId FK
        float value
        int installments
        LoanStatus status
        datetime createdAt
        datetime updatedAt
    }
    
    Company ||--o{ Employee : "tem"
    Employee ||--o{ Loan : "solicita"
```

### Enums
```typescript
enum LoanStatus {
  PAID       // Pago
  PENDING    // Pendente
  PROCESSING // Processando
  REJECTED   // Rejeitado
}
```

## üîê Sistema de Autentica√ß√£o

### Auth Module
**Arquivos:** `src/api/auth/`

#### AuthController
**Endpoint:** `POST /auth`

**Funcionalidade:** Autentica√ß√£o de usu√°rios (empresas e funcion√°rios)

**Request:**
```typescript
{
  email: string;
  password: string;
  userType: 'employee' | 'company';
}
```

**Response:**
```typescript
{
  user: {
    id: number;
    name: string;
    email: string;
    userType: string;
  };
  token: string; // JWT Token
}
```

#### AuthService
**Funcionalidades:**
- **signIn:** Autentica√ß√£o com bcrypt
- **getCompany:** Busca empresa por email
- **getEmployee:** Busca funcion√°rio por email
- **JWT:** Gera√ß√£o de token com payload

#### AuthGuard
**Funcionalidade:** Prote√ß√£o de rotas com JWT

**Implementa√ß√£o:**
- Extrai token do header Authorization
- Verifica assinatura JWT
- Adiciona payload ao request como `request.user`
- Lan√ßa UnauthorizedException se inv√°lido

## üè¢ M√≥dulo de Empresas

### Company Module
**Arquivos:** `src/api/company/`

#### CompanyController
**Endpoints:**
- `POST /company` - Criar empresa
- `GET /company` - Listar empresas (protegida)
- `GET /company/:id` - Buscar empresa (protegida)
- `PATCH /company/:id` - Atualizar empresa (protegida)
- `DELETE /company/:id` - Remover empresa (protegida)

#### CompanyService
**Funcionalidades:**
- **create:** Cria√ß√£o com hash da senha e valida√ß√£o de CNPJ √∫nico
- **findAll:** Listagem sem senhas
- **findOne:** Busca por ID sem senha
- **update:** Atualiza√ß√£o com hash opcional da senha
- **remove:** Remo√ß√£o com verifica√ß√£o de exist√™ncia

**Valida√ß√µes:**
- CNPJ √∫nico no sistema
- Hash de senha com bcrypt (saltRounds: 10)
- Exclus√£o da senha nas respostas

#### DTOs
- **CreateCompanyDto:** Valida√ß√£o de cria√ß√£o
- **UpdateCompanyDto:** Valida√ß√£o de atualiza√ß√£o

## üë• M√≥dulo de Funcion√°rios

### Employee Module
**Arquivos:** `src/api/employee/`

#### EmployeeController
**Endpoints:**
- `POST /employee` - Criar funcion√°rio
- `GET /employee` - Listar funcion√°rios (protegida)
- `GET /employee/:id` - Buscar funcion√°rio (protegida)
- `GET /employee/loans/:id` - Listar empr√©stimos do funcion√°rio (protegida)
- `PATCH /employee/:id` - Atualizar funcion√°rio (protegida)
- `DELETE /employee/:id` - Remover funcion√°rio (protegida)

#### EmployeeService
**Funcionalidades:**
- **create:** Cria√ß√£o com valida√ß√£o de CPF e empresa
- **findAll:** Listagem sem senhas
- **findOne:** Busca por ID sem senha
- **update:** Atualiza√ß√£o com valida√ß√£o de CPF √∫nico
- **remove:** Remo√ß√£o com verifica√ß√£o
- **employeeLoans:** Listagem de empr√©stimos do funcion√°rio

**Valida√ß√µes:**
- CPF √∫nico no sistema
- Empresa deve existir (por CNPJ)
- Hash de senha com bcrypt (saltRounds: 10)
- Exclus√£o da senha nas respostas

#### DTOs
- **CreateEmployeeDto:** Valida√ß√£o com companyCnpj
- **UpdateEmployeeDto:** Valida√ß√£o de atualiza√ß√£o

## üí∞ M√≥dulo de Empr√©stimos

### Loan Module
**Arquivos:** `src/api/loan/`

#### LoanController
**Endpoints:**
- `POST /loan` - Criar empr√©stimo (protegida)
- `GET /loan` - Listar empr√©stimos (protegida)
- `GET /loan/:id` - Buscar empr√©stimo (protegida)
- `PATCH /loan/:id` - Atualizar empr√©stimo (protegida)
- `DELETE /loan/:id` - Remover empr√©stimo (protegida)

#### LoanService
**Funcionalidades:**
- **create:** Cria√ß√£o com valida√ß√£o de funcion√°rio
- **findAll:** Listagem com dados do funcion√°rio
- **findOne:** Busca por ID com relacionamentos
- **update:** Atualiza√ß√£o com verifica√ß√£o de exist√™ncia
- **remove:** Remo√ß√£o com verifica√ß√£o

**Relacionamentos:**
- Inclui dados do funcion√°rio nas consultas
- Valida√ß√£o de exist√™ncia do funcion√°rio

#### DTOs
- **CreateLoanDto:** employeeId, amount, installments
- **UpdateLoanDto:** Campos opcionais para atualiza√ß√£o

## üìà M√≥dulo de An√°lise

### Analysis Module
**Arquivos:** `src/api/analysis/`

#### AnalysisController
**Endpoints:**
- `POST /analysis` - Validar empr√©stimo

#### AnalysisService
**Funcionalidades:**
- **validateLoan:** An√°lise de score baseada no valor
- **findPayment:** Simula√ß√£o de processamento de pagamento

**Regras de Score:**
```typescript
if (amount <= 2000) return { score: 400 };
if (amount <= 4000) return { score: 500 };
if (amount <= 8000) return { score: 600 };
if (amount <= 12000) return { score: 700 };
return { score: 0 };
```

**Simula√ß√£o de Pagamento:**
- Timeout aleat√≥rio entre 1-20 segundos
- Status PAID se < 10 segundos
- Status PENDING se > 10 segundos
- Processamento em background

#### DTOs
- **ValidateAnalysisDto:** Valida√ß√£o de an√°lise

## üóÑÔ∏è Servi√ßo de Banco de Dados

### Prisma Module
**Arquivos:** `src/prisma/`

#### PrismaService
**Funcionalidade:** Extens√£o do PrismaClient com inicializa√ß√£o autom√°tica

```typescript
@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit {
  async onModuleInit() {
    await this.$connect();
  }
}
```

**Configura√ß√£o:**
- **Provider:** SQLite
- **Conex√£o:** Autom√°tica na inicializa√ß√£o
- **Migrations:** Versionamento de schema
- **Client:** Gera√ß√£o autom√°tica

## üìù Documenta√ß√£o API

### Swagger Configuration
**Configura√ß√£o em main.ts:**
```typescript
const config = new DocumentBuilder()
  .setTitle('Credifit_API')
  .setDescription('API para simula√ß√£o de empr√©stimos')
  .setVersion('1.0')
  .addServer(`http://localhost:3000`, 'Servidor Local')
  .build();
```

**Acesso:** `http://localhost:3000/api`

### Decorators Swagger
**Utilizados em todos os controllers:**
- `@ApiTags()` - Agrupamento de endpoints
- `@ApiOperation()` - Descri√ß√£o da opera√ß√£o
- `@ApiResponse()` - Respostas poss√≠veis
- `@ApiBearerAuth()` - Autentica√ß√£o necess√°ria

## üîí Seguran√ßa

### Autentica√ß√£o JWT
**Configura√ß√£o:**
- **Secret:** process.env.JWT_SECRET
- **Algoritmo:** HS256 (padr√£o)
- **Header:** Authorization: Bearer {token}

### Criptografia
**bcrypt:**
- **Salt Rounds:** 10
- **Uso:** Hash de senhas de empresas e funcion√°rios

### Valida√ß√£o
**class-validator:**
- **Pipe Global:** ValidationPipe com whitelist
- **Transform:** Trim autom√°tico em strings
- **Sanitiza√ß√£o:** Remo√ß√£o de propriedades n√£o permitidas

### CORS
**Configura√ß√£o:**
- **Origin:** '*' (desenvolvimento)
- **Methods:** GET, POST, PATCH, DELETE, OPTIONS
- **Headers:** Content-Type, Authorization

## üìã DTOs e Valida√ß√µes

### Padr√£o de DTOs
```typescript
export class CreateEntityDto {
  @ApiProperty()
  @IsString()
  @IsNotEmpty()
  @Transform(({ value }) => value?.trim())
  field: string;
}
```

### Valida√ß√µes Comuns
- **@IsString()** - Valida√ß√£o de string
- **@IsNotEmpty()** - Campo obrigat√≥rio
- **@IsEmail()** - Valida√ß√£o de email
- **@Transform()** - Transforma√ß√£o de dados
- **@ApiProperty()** - Documenta√ß√£o Swagger

## üß™ Testes

### Estrutura de Testes
```
src/
‚îú‚îÄ‚îÄ **/*.spec.ts        # Testes unit√°rios
test/
‚îú‚îÄ‚îÄ app.e2e-spec.ts     # Testes E2E
‚îî‚îÄ‚îÄ jest-e2e.json       # Configura√ß√£o E2E
```

### Configura√ß√£o Jest
**Arquivo:** `package.json`
```json
{
  "jest": {
    "moduleFileExtensions": ["js", "json", "ts"],
    "rootDir": "src",
    "testRegex": ".*\\.spec\\.ts$",
    "transform": { "^.+\\.(t|j)s$": "ts-jest" },
    "collectCoverageFrom": ["**/*.(t|j)s"],
    "coverageDirectory": "../coverage",
    "testEnvironment": "node"
  }
}
```

### Comandos de Teste
```bash
npm run test          # Testes unit√°rios
npm run test:watch    # Testes em modo watch
npm run test:cov      # Cobertura de testes
npm run test:e2e      # Testes E2E
```

## üöÄ Deployment

### Build de Produ√ß√£o
```bash
npm run build         # Compila TypeScript
npm run start:prod    # Inicia aplica√ß√£o
```

### Estrutura de Build
```
dist/
‚îú‚îÄ‚îÄ main.js           # Aplica√ß√£o compilada
‚îú‚îÄ‚îÄ **/*.js           # M√≥dulos compilados
‚îî‚îÄ‚îÄ **/*.d.ts         # Declara√ß√µes TypeScript
```

### Vari√°veis de Ambiente
```env
DATABASE_URL="file:./dev.db"
JWT_SECRET="your-secret-key"
PORT=3000
```

## üìä Performance e Monitoramento

### Logging
**Console logs para:**
- Inicializa√ß√£o da aplica√ß√£o
- Erros de autentica√ß√£o
- Opera√ß√µes de banco de dados
- Processamento de an√°lises

### Otimiza√ß√µes
- **Prisma:** Consultas otimizadas com select espec√≠fico
- **bcrypt:** Salt rounds balanceados (10)
- **JWT:** Payload m√≠nimo
- **Validation:** Pipes globais eficientes

## üîÑ Fluxos de Neg√≥cio

### Fluxo de Autentica√ß√£o
```mermaid
sequenceDiagram
    participant C as Client
    participant API as Auth Controller
    participant S as Auth Service
    participant DB as Database
    
    C->>API: POST /auth {email, password, userType}
    API->>S: signIn(authDto)
    S->>DB: findUnique(email)
    DB-->>S: user data
    S->>S: bcrypt.compare(password)
    S->>S: jwtService.sign(payload)
    S-->>API: {user, token}
    API-->>C: Authentication response
```

### Fluxo de Cria√ß√£o de Empr√©stimo
```mermaid
sequenceDiagram
    participant C as Client
    participant LC as Loan Controller
    participant LS as Loan Service
    participant DB as Database
    
    C->>LC: POST /loan {employeeId, amount, installments}
    LC->>LS: create(createLoanDto)
    LS->>DB: employee.findUnique(employeeId)
    DB-->>LS: employee data
    LS->>DB: loan.create(loanData)
    DB-->>LS: created loan
    LS-->>LC: loan result
    LC-->>C: Created loan response
```

## üõ†Ô∏è Desenvolvimento

### Comandos Principais
```bash
# Desenvolvimento
npm run start:dev     # Modo watch
npm run start:debug   # Modo debug

# Build
npm run build         # Compila√ß√£o

# Testes
npm run test          # Unit√°rios
npm run test:e2e      # E2E

# Linting
npm run lint          # ESLint
npm run format        # Prettier

# Prisma
npx prisma migrate dev    # Migra√ß√µes
npx prisma generate      # Gerar client
npx prisma studio        # Interface visual
```

### Estrutura de Desenvolvimento
```
src/api/[module]/
‚îú‚îÄ‚îÄ [module].controller.ts      # Endpoints HTTP
‚îú‚îÄ‚îÄ [module].service.ts         # L√≥gica de neg√≥cio
‚îú‚îÄ‚îÄ [module].module.ts          # Configura√ß√£o do m√≥dulo
‚îú‚îÄ‚îÄ dto/                        # Data Transfer Objects
‚îÇ   ‚îú‚îÄ‚îÄ create-[module].dto.ts
‚îÇ   ‚îî‚îÄ‚îÄ update-[module].dto.ts
‚îú‚îÄ‚îÄ entities/                   # Entidades para Swagger
‚îÇ   ‚îî‚îÄ‚îÄ [module].entity.ts
‚îî‚îÄ‚îÄ [module].controller.spec.ts # Testes unit√°rios
```

## üîß Configura√ß√µes

### ESLint
**Arquivo:** `eslint.config.mjs`
- **Extends:** @nestjs/eslint-config
- **Parser:** @typescript-eslint/parser
- **Rules:** Padr√£o NestJS

### TypeScript
**Arquivo:** `tsconfig.json`
- **Target:** ES2020
- **Module:** commonjs
- **Strict:** true
- **Decorators:** experimentalDecorators

### Nest CLI
**Arquivo:** `nest-cli.json`
- **Language:** ts
- **Collection:** @nestjs/schematics
- **Source Root:** src

## üìà M√©tricas e Monitoramento

### Endpoints de Health
- **Swagger UI:** `/api` - Documenta√ß√£o interativa
- **Application:** `/` - Status da aplica√ß√£o

### Logs Importantes
- **Bootstrap:** Inicializa√ß√£o da aplica√ß√£o
- **Auth Errors:** Falhas de autentica√ß√£o
- **Database:** Opera√ß√µes de banco
- **Analysis:** Processamento de an√°lises

## üîÆ Poss√≠veis Melhorias

### Seguran√ßa
1. **Rate Limiting:** Implementar throttling
2. **HTTPS:** Certificados SSL
3. **Environment Variables:** Configura√ß√£o segura
4. **Input Sanitization:** Sanitiza√ß√£o avan√ßada

### Performance
1. **Database Indexing:** √çndices otimizados
2. **Caching:** Redis para cache
3. **Connection Pooling:** Pool de conex√µes
4. **Query Optimization:** Consultas eficientes

### Monitoring
1. **Health Checks:** Endpoints de sa√∫de
2. **Metrics:** Prometheus/Grafana
3. **Logging:** Structured logging
4. **Tracing:** OpenTelemetry

### Testing
1. **Unit Tests:** Cobertura completa
2. **Integration Tests:** Testes de integra√ß√£o
3. **E2E Tests:** Cen√°rios completos
4. **Performance Tests:** Testes de carga

---

## üìö Refer√™ncias

- [NestJS Documentation](https://docs.nestjs.com)
- [Prisma Documentation](https://www.prisma.io/docs)
- [JWT Documentation](https://jwt.io)
- [Swagger/OpenAPI](https://swagger.io/specification/)
- [bcrypt Documentation](https://www.npmjs.com/package/bcrypt)